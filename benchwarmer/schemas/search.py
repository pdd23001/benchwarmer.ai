"""Shared schemas for PDF pipeline, search, and code generation outputs."""

from dataclasses import dataclass, field
from typing import List, Literal, Optional


# ---------------------------------------------------------------------------
# PDF content extracted from uploaded research papers
# ---------------------------------------------------------------------------

@dataclass
class PDFContent:
    """Structured content extracted from an uploaded research paper PDF."""

    file_path: str
    title: str
    abstract: Optional[str] = None
    full_text: str = ""
    algorithm_keywords: List[str] = field(default_factory=list)
    github_urls: List[str] = field(default_factory=list)
    summary: str = ""


# ---------------------------------------------------------------------------
# Code representations
# ---------------------------------------------------------------------------

@dataclass
class CodeSnippet:
    """A single extracted code block for sandbox execution."""

    content: str
    language: str
    file_path: Optional[str] = None
    start_line: Optional[int] = None
    end_line: Optional[int] = None


@dataclass
class ImplementationCandidate:
    """A candidate GitHub (or other) implementation with runnable snippets."""

    source_repo_url: str
    commit_or_ref: Optional[str] = None
    language: str = "python"
    entrypoint_guess: Optional[str] = None
    dependency_hints: List[str] = field(default_factory=list)
    license_text_or_url: Optional[str] = None
    snippets: List[CodeSnippet] = field(default_factory=list)
    confidence: float = 0.0
    algorithm_name_match: Optional[str] = None
    problem_class_match: Optional[str] = None


@dataclass
class GeneratedCode:
    """Code generated by Claude when no existing implementation is found."""

    code: str
    language: str = "python"
    explanation: str = ""
    dependency_hints: List[str] = field(default_factory=list)
    paper_title: str = ""
    algorithm_name: str = ""


@dataclass
class ExecutionResult:
    """Result of running code in the Modal sandbox."""

    stdout: str = ""
    stderr: str = ""
    exit_code: int = 0
    runtime_seconds: float = 0.0
    error: Optional[str] = None


# ---------------------------------------------------------------------------
# Pipeline result: the unified return type for the PDF pipeline
# ---------------------------------------------------------------------------

@dataclass
class PipelineResult:
    """
    Unified result of the PDF pipeline.

    source is one of:
      - "github"   : existing implementation found via Perplexity â†’ GitHub
      - "generated" : Claude generated the code from the paper
      - "none"     : nothing found or generated
    """

    source: Literal["github", "generated", "none"]
    pdf_content: Optional[PDFContent] = None
    implementations: List[ImplementationCandidate] = field(default_factory=list)
    generated_code: Optional[GeneratedCode] = None
    execution_result: Optional[ExecutionResult] = None
    provenance: Optional[dict] = None


# ---------------------------------------------------------------------------
# Legacy / shared schemas (still used by tools.py)
# ---------------------------------------------------------------------------

@dataclass
class PaperCandidate:
    """A research paper candidate for OCR fallback."""

    title: str
    url: str
    doi: Optional[str] = None
    arxiv_id: Optional[str] = None
    abstract_snippet: Optional[str] = None
    relevance_score: float = 0.0
    candidate_algorithm_names: List[str] = field(default_factory=list)


@dataclass
class SearchConstraints:
    """Optional constraints for search_algorithms (problem class, algorithm names, etc.)."""

    problem_class: Optional[str] = None
    algorithm_names: Optional[List[str]] = None
    languages: Optional[List[str]] = None
    min_confidence: Optional[float] = None


@dataclass
class SearchResult:
    """Return type of search_algorithms(query, constraints)."""

    found_implementation: bool
    implementations: List[ImplementationCandidate] = field(default_factory=list)
    papers: List[PaperCandidate] = field(default_factory=list)
    next_action: Literal["run_code", "ocr_pipeline", "generate_code"] = "ocr_pipeline"
    query: str = ""
    provenance: Optional[dict] = None


@dataclass
class SandboxCodeUnit:
    """Single runnable code unit for the sandbox (file-level or snippet)."""

    content: str
    language: str
    file_path: Optional[str] = None
    source_repo_url: Optional[str] = None
    commit_or_ref: Optional[str] = None
    entrypoint_guess: Optional[str] = None


@dataclass
class SandboxPayload:
    """
    Payload for Claude/Modal sandbox execution: raw code snippets plus metadata.
    Built from SearchResult when found_implementation is True.
    """

    query: str
    code_units: List[SandboxCodeUnit] = field(default_factory=list)
    dependency_hints: List[str] = field(default_factory=list)
    license_text_or_url: Optional[str] = None
    provenance: Optional[dict] = None
